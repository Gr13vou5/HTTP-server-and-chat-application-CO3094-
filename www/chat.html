<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="css/chat.css">
</head>
<body>

    <!-- Theme Toggle Button -->
    <button id="themeToggle" class="theme-btn">ðŸŒ™ Light Mode</button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">Chat</h1>
                <button id="connectBtn" class="connect-btn">
                    <span class="btn-text">ONLINE</span>
                    <span class="status-dot"></span>
                </button>
            </div>

            <div class="user-list-label">Online Users</div>
            <ul class="user-list" id="userList">
                <!-- Users populated by JS -->
            </ul>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-area">
            <div id="chatView" style="display: none; height: 100%; flex-direction: column;">
                <header class="chat-header">
                    <div class="user-avatar" id="headerAvatar"></div>
                    <div class="chat-header-info">
                        <h2 id="headerName">User Name</h2>
                        <div class="chat-header-status" id="headerStatus">Online</div>
                    </div>
                </header>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages appear here -->
                </div>

                <div class="input-area">
                    <input type="text" id="messageInput" class="message-input" placeholder="Type a message...">
                    <button id="sendBtn" class="send-btn">
                        <svg viewBox="0 0 24 24">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">ðŸ‘‹</div>
                <h3>Welcome</h3>
                <p>Select a user from the list to start chatting</p>
            </div>
        </main>
    </div>

    <script>
        /* ----------------------------
           THEME TOGGLE
        ---------------------------- */

        const themeBtn = document.getElementById("themeToggle");
        const body = document.body;

        // Default DARK MODE
        body.classList.add("dark-mode");

        themeBtn.addEventListener("click", () => {
            if (body.classList.contains("light-mode")) {
                body.classList.remove("light-mode");
                body.classList.add("dark-mode");
                themeBtn.textContent = "ðŸŒ™ Light Mode";
            } else {
                body.classList.remove("dark-mode");
                body.classList.add("light-mode");
                themeBtn.textContent = "â˜€ Dark Mode";
            }
        });

        /* ----------------------------
           APP LOGIC
        ---------------------------- */

        let users = [];
        let messages = {};
        let currentUserId = null;
        let isConnected = false;
        let currentUserIP = null;

        async function getMessages() {
            try {
                const res = await fetch('/api/get-messages');
                return await res.text();
            } catch (err) {
                return "{}";
            }
        }

        async function getUsers() {
            try {
                const res = await fetch('/get-list');
                const data = await res.json();
                const peers = data.peer_list || {};

                return Object.entries(peers).map(([key, u]) => ({
                    id: key,
                    name: key,
                    status: u.active ? "online" : "offline",
                    avatarColor: getRandomColor()
                }));
            } catch (err) {
                return [];
            }
        }

        function getRandomColor() {
            const colors = [
                'linear-gradient(135deg, #FF6B6B, #EE5253)',
                'linear-gradient(135deg, #48DBFB, #0ABDE3)',
                'linear-gradient(135deg, #1DD1A1, #10AC84)',
                'linear-gradient(135deg, #F368E0, #FF9FF3)',
                'linear-gradient(135deg, #FF9F43, #EE5A24)'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        async function getCurrentIp() {
            const res = await fetch("/userip");
            return res.statusText;
        }

        // DOM
        const userListEl = document.getElementById('userList');
        const chatViewEl = document.getElementById('chatView');
        const emptyStateEl = document.getElementById('emptyState');
        const headerNameEl = document.getElementById('headerName');
        const headerStatusEl = document.getElementById('headerStatus');
        const headerAvatarEl = document.getElementById('headerAvatar');
        const messagesContainerEl = document.getElementById('messagesContainer');
        const messageInputEl = document.getElementById('messageInput');
        const sendBtnEl = document.getElementById('sendBtn');
        const connectBtnEl = document.getElementById('connectBtn');

        async function init() {
            currentUserIP = await getCurrentIp();
            users = await getUsers();

            let rawMessages = await getMessages();
            try { messages = JSON.parse(rawMessages); }
            catch { messages = {}; }

            renderUserList();
            setupEventListeners();
        }

        function renderUserList() {
            userListEl.innerHTML = "";

            users.forEach(user => {
                if (user.id === currentUserIP) return;

                const li = document.createElement("li");
                li.className = `user-item ${user.status}`;

                li.onclick = () => selectUser(user.id);

                const initials = user.name.charAt(0).toUpperCase();

                li.innerHTML = `
                    <div class="user-avatar" style="background:${user.avatarColor}">
                        ${initials}
                        <div class="status-indicator"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name">${user.name}</div>
                        <div class="user-status-text">${user.status}</div>
                    </div>
                `;

                userListEl.appendChild(li);
            });
        }

        function selectUser(id) {
            if (!isConnected) return alert("Please connect first!");

            currentUserId = id;
            const user = users.find(u => u.id === id);

            emptyStateEl.style.display = "none";
            chatViewEl.style.display = "flex";

            headerNameEl.textContent = user.name;
            headerStatusEl.textContent = user.status;
            headerAvatarEl.style.background = user.avatarColor;
            headerAvatarEl.textContent = user.name.charAt(0);

            renderMessages();
        }

        function renderMessages() {
            messagesContainerEl.innerHTML = "";

            const peerList = messages[currentUserId] || [];
            const myList   = messages[currentUserIP] || [];

            const all = [...peerList, ...myList].sort((a, b) => a.id - b.id);

            all.forEach(msg => {
                if (msg.sender !== currentUserId && msg.sender !== currentUserIP) return;

                const div = document.createElement("div");
                div.className = "message " + (msg.sender === currentUserIP ? "sent" : "received");
                div.innerHTML = `
                    ${msg.text}
                    <div class="message-time">${msg.time}</div>
                `;
                messagesContainerEl.appendChild(div);
            });

            messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
        }

        function sendMessagetoPeer(message) {
            fetch("/send-message", {
                method: "POST",
                headers: {
                    "Host": currentUserIP,
                    "Receiver": currentUserId,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message })
            });
        }

        function sendMessage() {
            const text = messageInputEl.value.trim();
            if (!text || !currentUserId) return;

            const newMsg = {
                id: Date.now(),
                text,
                sender: currentUserIP,
                receiver: currentUserId,
                time: new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
            };

            if (!messages[currentUserId]) messages[currentUserId] = [];
            messages[currentUserId].push(newMsg);

            sendMessagetoPeer(newMsg);
            messageInputEl.value = "";
            renderMessages();
        }

        function toggleConnect() {
            isConnected = !isConnected;
            const btnText = connectBtnEl.querySelector('.btn-text');

            if (isConnected) {
                btnText.textContent = "ONLINE";
                connectBtnEl.classList.add("connected");

                fetch("/add-list", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        ip: currentUserIP.split(":")[0],
                        port: currentUserIP.split(":")[1],
                        active: true
                    })
                });

            } else {
                btnText.textContent = "OFFLINE";
                connectBtnEl.classList.remove("connected");

                chatViewEl.style.display = "none";
                emptyStateEl.style.display = "flex";
            }

            renderUserList();
        }

        function setupEventListeners() {
            connectBtnEl.addEventListener("click", toggleConnect);
            sendBtnEl.addEventListener("click", sendMessage);

            messageInputEl.addEventListener("keypress", e => {
                if (e.key === "Enter") sendMessage();
            });
        }

        setInterval(async () => {
            if (!isConnected) return;

            let raw = await getMessages();
            try {
                const parsed = JSON.parse(raw);

                if (JSON.stringify(parsed) !== JSON.stringify(messages)) {
                    messages = parsed;
                    if (currentUserId) renderMessages();
                }
            } catch {}
        }, 2000);

        init();
    </script>

</body>
</html>
